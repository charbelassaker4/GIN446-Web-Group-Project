<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>DreamFIT — Login</title>
    <link rel="stylesheet" href="login.css" />
  </head>
  <body>
    <div class="page-wrap">
      <div class="card">
        <h1>Welcome Back</h1>
        <p class="subtitle">Log in to continue your DreamFIT journey</p>

        <div id="alert" class="alert" style="display: none"></div>

        <form id="login-form" class="form">
          <div class="field">
            <span>Email</span>
            <input type="email" id="email" required />
          </div>
          <div class="field">
            <span>Password</span>
            <input type="password" id="password" required />
          </div>
          <button type="submit" class="btn primary">Log In</button>
        </form>

        <div class="alt small">
          Don’t have an account? <a href="signup.html">Sign up</a>
        </div>

        <div class="alt">──────── or ────────</div>
        <button id="google-login" class="btn primary">
          Sign in with Google
        </button>
      </div>
    </div>

    <script type="module">
      import { auth } from "../../firebase/initialise.js";
      import {
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

      const form = document.getElementById("login-form");
      const googleBtn = document.getElementById("google-login");
      const alertBox = document.getElementById("alert");

      // Email/Password Sign-In
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        alertBox.style.display = "none";

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        try {
          const result = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          const isNewUser = result?._tokenResponse?.isNewUser;

          if (isNewUser) {
            window.location.href = "user_setup.html";
          } else {
            window.location.href = "../index.html";
          }
        } catch (error) {
          let msg = "Login failed. Try again.";
          if (error.code === "auth/user-not-found")
            msg = "No account found for that email.";
          else if (error.code === "auth/wrong-password")
            msg = "Incorrect password.";
          else if (error.code === "auth/invalid-email")
            msg = "Invalid email address.";
          alertBox.textContent = msg;
          alertBox.classList.add("error");
          alertBox.style.display = "block";
        }
      });
      // Google Sign-In
      googleBtn.addEventListener("click", async () => {
        alertBox.style.display = "none";
        const provider = new GoogleAuthProvider();

        try {
          const result = await signInWithPopup(auth, provider);
          const isNewUser = result?._tokenResponse?.isNewUser;

          if (isNewUser) {
            window.location.href = "user_setup.html";
          } else {
            window.location.href = "../index.html";
          }
        } catch (error) {
          console.error(error);
          alertBox.textContent = "Google sign-in failed. Please try again.";
          alertBox.classList.add("error");
          alertBox.style.display = "block";
        }
      });
    </script>
    <script type="module" src="../../firebase/initialise.js"></script>
  </body>
</html>
