<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DreamFIT — Your Details</title>
  <link rel="stylesheet" href="login.css" />
</head>
<body>
  <div class="page-wrap">
    <div class="card">
      <h1>Let’s Get to Know You</h1>
      <p class="subtitle">Please fill out the following information:</p>

      <form id="user-setup-form" class="form">
        <div class="field"><span>Age</span><input type="number" id="age" min="10" max="100" required /></div>
        <div class="field"><span>Weight (kg)</span><input type="number" id="weight" step="0.1" min="20" max="300" required /></div>
        <div class="field"><span>Height (cm)</span><input type="number" id="height" min="100" max="250" required /></div>
        <div class="field"><span>Workouts per week</span><input type="number" id="workouts" min="0" max="14" required /></div>
        <div class="field"><span>Activity Level</span>
          <select id="activity" required>
            <option value="">Select...</option>
            <option>Not very active</option>
            <option>Lightly active</option>
            <option>Active</option>
            <option>Very active</option>
          </select>
        </div>
        <div class="field"><span>Goal</span>
          <select id="goal" required>
            <option value="">Select...</option>
            <option>Lose weight</option>
            <option>Maintain weight</option>
            <option>Gain weight</option>
          </select>
        </div>
        <div class="field"><span>Sex</span>
          <select id="sex" required>
            <option value="">Select...</option>
            <option>Male</option>
            <option>Female</option>
          </select>
        </div>
        <div class="field"><span>Date of Birth</span><input type="date" id="dob" required /></div>
        <div class="field"><span>Country</span><input type="text" id="country" required /></div>

        <button class="btn primary full-width" type="submit">Save & Continue</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth } from "../../firebase/initialise.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const form = document.getElementById("user-setup-form");

    // Ensure user is logged in
    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "login.html";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Get email from signup stored in localStorage
      const savedData = JSON.parse(localStorage.getItem("dreamfit-user-details")) || {};
      const userEmail = savedData.email;
      if (!userEmail) {
        alert("Could not get your signup email. Please sign up again.");
        window.location.href = "signup.html";
        return;
      }

      const formattedDOB = new Date(form.dob.value).toISOString().split("T")[0];

      const data = {
        email: userEmail, // signup email
        age: form.age.value,
        weight: form.weight.value,
        height: form.height.value,
        workouts: form.workouts.value,
        activity: form.activity.value,
        goal: form.goal.value,
        sex: form.sex.value,
        dob: formattedDOB,
        country: form.country.value
      };

      localStorage.setItem("dreamfit-user-details", JSON.stringify({ ...savedData, ...data }));

      try {
        const response = await fetch("save_user.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");

        const status = xmlDoc.getElementsByTagName("status")[0]?.textContent;
        const message = xmlDoc.getElementsByTagName("message")[0]?.textContent;

        if (status === "success") {
          alert("Your information has been saved!");
          window.location.href = "../index.html";
        } else {
          alert("Error: " + (message || "Unknown XML response"));
        }

      } catch (error) {
        alert("Connection error: " + error);
      }
    });
  </script>
</body>
</html>
