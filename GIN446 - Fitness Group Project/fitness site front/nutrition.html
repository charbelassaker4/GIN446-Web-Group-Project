<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DreamFIT â€” Nutrition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase state -->
  <script type="module" src="../firebase/state_listener.js"></script>

  <style>
    .hidden { display: none !important; }

    .recommended-card {
      margin-top: 1rem;
      padding: 1rem 1.1rem;
      border-radius: 1rem;
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.25), rgba(15,23,42,0.95));
    }
    .recommended-card h3 {
      font-size: 1rem;
      margin-bottom: 0.4rem;
      color: #a5f3fc;
    }
  </style>
</head>

<body>
<header class="site-header">
  <div class="logo">Dream<span>FIT</span></div>
  <nav class="main-nav">
    <a href="../index.html">Home</a>
    <a href="bmi.html">BMI</a>
    <a href="bodyfat.html">Body Fat %</a>
    <a href="workout.html">Workouts</a>
    <a href="nutrition.html" class="active">Nutrition</a>
    <a href="muscle-composition.html">Muscle Viewer</a>
    <a href="profile.html">Profile</a>
    <button id="logout-btn" class="pill-btn">Logout</button>
  </nav>
</header>

<script type="module" src="../firebase/signout.js"></script>

<main class="page-wide">
  <h1>Nutrition Dashboard</h1>
  <p class="page-intro">Track calories, plan meals, and search foods using the USDA database.</p>

  <div style="display:flex; gap:1rem; margin-bottom:1.5rem">
    <button class="btn ghost" id="tab-targets">Daily Targets</button>
    <button class="btn ghost" id="tab-meals">Meal Planner</button>
    <button class="btn ghost" id="tab-search">Food Search</button>
  </div>

  <!-- DAILY TARGETS -->
  <section id="targets-section" class="card-section">
    <div class="recommended-card">
      <h3>Recommended Daily Intake</h3>
      <p id="recommended-kcal">Calories: â€”</p>
      <p id="recommended-protein">Protein: â€” g</p>
      <p id="recommended-carbs">Carbs: â€” g</p>
      <p id="recommended-fat">Fat: â€” g</p>
      <p id="recommended-fiber">Fiber: â€” g</p>
    </div>

    <h2 style="margin-top:1.2rem;">Your Daily Macro Targets</h2>
    <p class="small-muted">You can manually edit these numbers or use the recommended above.</p>

    <form id="target-form" class="target-grid">
      <div class="field"><label>Calories (kcal)</label><input type="number" id="target-kcal"></div>
      <div class="field"><label>Protein (g)</label><input type="number" id="target-protein"></div>
      <div class="field"><label>Carbs (g)</label><input type="number" id="target-carbs"></div>
      <div class="field"><label>Fat (g)</label><input type="number" id="target-fat"></div>
    </form>

    <button id="save-targets-btn" class="btn primary" style="margin-top:1rem">Save targets</button>

    <div class="macro-strip" style="margin-top:1rem">
      <div class="stat-card"><span id="stat-kcal" class="stat-number">â€” kcal</span><span class="stat-label">Daily calories</span></div>
      <div class="stat-card"><span id="stat-protein" class="stat-number">â€” g</span><span class="stat-label">Daily protein</span></div>
    </div>

    <div class="card-section" style="margin-top:1rem">
      <h2 style="font-size:1rem">Todayâ€™s macro progress</h2>
      <div class="macro-bars">
        <div><div class="macro-bar-label"><span>Calories</span><span id="bar-kcal-label">0 / 0</span></div><div class="macro-bar"><div class="macro-bar-fill" id="bar-kcal-fill"></div></div></div>
        <div><div class="macro-bar-label"><span>Protein</span><span id="bar-protein-label">0 / 0</span></div><div class="macro-bar"><div class="macro-bar-fill" id="bar-protein-fill"></div></div></div>
        <div><div class="macro-bar-label"><span>Carbs</span><span id="bar-carbs-label">0 / 0</span></div><div class="macro-bar"><div class="macro-bar-fill" id="bar-carbs-fill"></div></div></div>
        <div><div class="macro-bar-label"><span>Fat</span><span id="bar-fat-label">0 / 0</span></div><div class="macro-bar"><div class="macro-bar-fill" id="bar-fat-fill"></div></div></div>
      </div>

      <p id="macro-status-tag" class="tag-muted">No meals logged yet.</p>
    </div>
  </section>

  <!-- MEAL PLANNER -->
  <section id="meals-section" class="card-section hidden">
    <h2>Meal Planner</h2>

    <form id="meal-form" class="meal-form-grid">
      <div class="field full-width"><label>Meal name</label><input type="text" id="meal-name" required></div>
      <div class="field"><label>Kcal</label><input type="number" id="meal-kcal" required></div>
      <div class="field"><label>Protein</label><input type="number" id="meal-protein" required></div>
      <div class="field"><label>Carbs</label><input type="number" id="meal-carbs" required></div>
      <div class="field"><label>Fat</label><input type="number" id="meal-fat" required></div>
      <div class="field"><label>Fiber</label><input type="number" id="meal-fiber" value="0"></div>

      <div class="add-meal-wrapper"><button class="btn primary" type="submit">Add Meal</button></div>
    </form>

    <div class="table-wrapper" style="margin-top:1rem">
      <table class="progress-table">
        <thead><tr><th>Meal</th><th>Kcal</th><th>P</th><th>C</th><th>F</th><th>Fi</th><th></th></tr></thead>
        <tbody id="meal-table-body"></tbody>
      </table>
    </div>

    <button id="clear-meals-btn" class="btn outline-danger small" style="margin-top:1rem">Reset todayâ€™s meals</button>

    <div class="summary-box" style="margin-top:1rem">
      <p><strong>Totals today:</strong></p>
      <p id="summary-kcal">Calories: 0</p>
      <p id="summary-protein">Protein: 0</p>
      <p id="summary-carbs">Carbs: 0</p>
      <p id="summary-fat">Fat: 0</p>
      <p id="summary-fiber">Fiber: 0</p>
    </div>
  </section>

  <!-- FOOD SEARCH -->
  <section id="search-section" class="card-section hidden">
    <h2>Food Database (USDA)</h2>

    <form id="food-search-form" class="form-grid">
      <div class="field full-width"><label>Food name</label><input id="food-search-input" type="text" placeholder="banana, chicken 100gâ€¦" required></div>
      <button class="btn primary full-width" type="submit">Search</button>
    </form>

    <p id="api-status" style="margin-top:0.5rem"></p>

    <div id="api-results-wrapper" class="table-wrapper hidden" style="margin-top:1rem">
      <table class="food-table">
        <thead><tr><th>Food</th><th>Serving</th><th>Kcal</th><th>P</th><th>C</th><th>F</th><th>Fi</th><th></th></tr></thead>
        <tbody id="api-results-body"></tbody>
      </table>
    </div>
  </section>

</main>

<footer class="site-footer">DreamFIT â€” Nutrition â€¢ Built with precision ðŸ’ª</footer>

<!-- ============================================================
     FULL WORKING JAVASCRIPT (LOCALSTORAGE FIXED)
     ============================================================ -->
<script>
/* =========================================================
   TABS
   ========================================================= */
const tabTargets = document.getElementById("tab-targets");
const tabMeals = document.getElementById("tab-meals");
const tabSearch = document.getElementById("tab-search");
const sectionTargets = document.getElementById("targets-section");
const sectionMeals = document.getElementById("meals-section");
const sectionSearch = document.getElementById("search-section");

function switchTab(show) {
  sectionTargets.classList.add("hidden");
  sectionMeals.classList.add("hidden");
  sectionSearch.classList.add("hidden");
  tabTargets.classList.remove("primary");
  tabMeals.classList.remove("primary");
  tabSearch.classList.remove("primary");
  show.section.classList.remove("hidden");
  show.tab.classList.add("primary");
}
tabTargets.onclick = () => switchTab({ section: sectionTargets, tab: tabTargets });
tabMeals.onclick   = () => switchTab({ section: sectionMeals, tab: tabMeals });
tabSearch.onclick  = () => switchTab({ section: sectionSearch, tab: tabSearch });
switchTab({ section: sectionTargets, tab: tabTargets });

/* =========================================================
   STORAGE KEYS
   ========================================================= */
const STORAGE_TARGET_KEY      = "dreamfit-nutrition-target-v1";
const STORAGE_MEALS_KEY       = "dreamfit-nutrition-meals-v1";
const STORAGE_RECOMMENDED_KEY = "dreamfit-nutrition-recommended-v1";

let targets = { kcal: null, protein: null, carbs: null, fat: null };
let meals = [];

/* =========================================================
   RECOMMENDED INTAKE â€” FIXED LOCAL STORAGE
   ========================================================= */
function loadRecommendedFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_RECOMMENDED_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    return parsed.values || parsed;
  } catch { return null; }
}

function saveRecommendedToStorage(snapshot, values) {
  localStorage.setItem(
    STORAGE_RECOMMENDED_KEY,
    JSON.stringify({ userSnapshot: snapshot, values })
  );
}

function calculateRecommended() {
  const rawUser = localStorage.getItem("dreamfit-user-details");
  if (!rawUser) return loadRecommendedFromStorage();

  let user;
  try { user = JSON.parse(rawUser); } catch { return loadRecommendedFromStorage(); }

  if (!user.weight || !user.height || !user.age || !user.sex || !user.activity)
    return loadRecommendedFromStorage();

  // Reuse cache when user didn't change
  try {
    const cache = JSON.parse(localStorage.getItem(STORAGE_RECOMMENDED_KEY));
    if (cache && cache.userSnapshot === rawUser) return cache.values;
  } catch {}

  // Calculate fresh values
  const w = parseFloat(user.weight);
  const h = parseFloat(user.height);
  const a = parseInt(user.age);

  let BMR = user.sex === "Male"
    ? 10*w + 6.25*h - 5*a + 5
    : 10*w + 6.25*h - 5*a - 161;

  const activity = {
    "Not very active": 1.2,
    "Lightly active": 1.375,
    "Active": 1.55,
    "Very active": 1.725
  }[user.activity] || 1.2;

  let TDEE = Math.round(BMR * activity);
  if (user.goal === "Lose weight") TDEE -= 300;
  if (user.goal === "Gain weight") TDEE += 300;

  const protein = Math.round(w * 2);
  const fat = Math.round((TDEE * 0.25) / 9);
  const carbs = Math.round((TDEE - (protein*4 + fat*9)) / 4);
  const fiber = Math.round(w * 0.8);

  const values = { kcal: TDEE, protein, carbs, fat, fiber };
  saveRecommendedToStorage(rawUser, values);

  return values;
}

function showRecommended() {
  const r = calculateRecommended();
  if (!r) return;

  document.getElementById("recommended-kcal").textContent = `Calories: ${r.kcal}`;
  document.getElementById("recommended-protein").textContent = `Protein: ${r.protein} g`;
  document.getElementById("recommended-carbs").textContent = `Carbs: ${r.carbs} g`;
  document.getElementById("recommended-fat").textContent = `Fat: ${r.fat} g`;
  document.getElementById("recommended-fiber").textContent = `Fiber: ${r.fiber} g`;
}

/* =========================================================
   TARGETS
   ========================================================= */
function loadTargets() {
  try {
    const raw = localStorage.getItem(STORAGE_TARGET_KEY);
    if (raw) targets = { ...targets, ...JSON.parse(raw) };
  } catch {}
}

function saveTargets() {
  localStorage.setItem(STORAGE_TARGET_KEY, JSON.stringify(targets));
}

document.getElementById("save-targets-btn").onclick = () => {
  targets.kcal = parseFloat(document.getElementById("target-kcal").value) || null;
  targets.protein = parseFloat(document.getElementById("target-protein").value) || null;
  targets.carbs = parseFloat(document.getElementById("target-carbs").value) || null;
  targets.fat = parseFloat(document.getElementById("target-fat").value) || null;
  saveTargets();
  updateTargetUI();
};

function updateTargetUI() {
  document.getElementById("target-kcal").value = targets.kcal || "";
  document.getElementById("target-protein").value = targets.protein || "";
  document.getElementById("target-carbs").value = targets.carbs || "";
  document.getElementById("target-fat").value = targets.fat || "";

  document.getElementById("stat-kcal").textContent =
    targets.kcal ? `${targets.kcal} kcal` : "â€” kcal";

  document.getElementById("stat-protein").textContent =
    targets.protein ? `${targets.protein} g` : "â€” g";
}

/* =========================================================
   MEALS
   ========================================================= */
function loadMeals() {
  try {
    meals = JSON.parse(localStorage.getItem(STORAGE_MEALS_KEY)) || [];
  } catch { meals = []; }
}

function saveMeals() {
  localStorage.setItem(STORAGE_MEALS_KEY, JSON.stringify(meals));
}

document.getElementById("meal-form").addEventListener("submit", e => {
  e.preventDefault();

  const meal = {
    name: document.getElementById("meal-name").value.trim(),
    kcal: parseFloat(document.getElementById("meal-kcal").value),
    protein: parseFloat(document.getElementById("meal-protein").value),
    carbs: parseFloat(document.getElementById("meal-carbs").value),
    fat: parseFloat(document.getElementById("meal-fat").value),
    fiber: parseFloat(document.getElementById("meal-fiber").value) || 0
  };

  meals.push(meal);
  saveMeals();
  renderMealsTable();
  updateMealSummary();
  e.target.reset();
});

document.getElementById("meal-table-body").onclick = e => {
  const btn = e.target.closest("button[data-index]");
  if (!btn) return;
  meals.splice(btn.dataset.index, 1);
  saveMeals();
  renderMealsTable();
  updateMealSummary();
};

document.getElementById("clear-meals-btn").onclick = () => {
  meals = [];
  saveMeals();
  renderMealsTable();
  updateMealSummary();
};

function renderMealsTable() {
  const tbody = document.getElementById("meal-table-body");
  tbody.innerHTML = "";
  meals.forEach((m, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${m.name}</td>
        <td>${m.kcal}</td>
        <td>${m.protein}</td>
        <td>${m.carbs}</td>
        <td>${m.fat}</td>
        <td>${m.fiber}</td>
        <td><button class="btn outline-danger small" data-index="${i}">Remove</button></td>
      </tr>`;
  });
}

function updateMealSummary() {
  const total = meals.reduce((a, m) => ({
    kcal: a.kcal + m.kcal,
    protein: a.protein + m.protein,
    carbs: a.carbs + m.carbs,
    fat: a.fat + m.fat,
    fiber: a.fiber + m.fiber
  }), { kcal:0, protein:0, carbs:0, fat:0, fiber:0 });

  document.getElementById("summary-kcal").textContent = `Calories: ${total.kcal}`;
  document.getElementById("summary-protein").textContent = `Protein: ${total.protein}`;
  document.getElementById("summary-carbs").textContent = `Carbs: ${total.carbs}`;
  document.getElementById("summary-fat").textContent = `Fat: ${total.fat}`;
  document.getElementById("summary-fiber").textContent = `Fiber: ${total.fiber}`;

  const bars = [
    { key:"kcal", label:"bar-kcal-label", fill:"bar-kcal-fill" },
    { key:"protein", label:"bar-protein-label", fill:"bar-protein-fill" },
    { key:"carbs", label:"bar-carbs-label", fill:"bar-carbs-fill" },
    { key:"fat", label:"bar-fat-label", fill:"bar-fat-fill" }
  ];

  bars.forEach(b => {
    const current = total[b.key];
    const target = targets[b.key] || 0;
    document.getElementById(b.label).textContent = `${current} / ${target}`;
    document.getElementById(b.fill).style.width =
      target ? Math.min((current / target) * 100, 150) + "%" : "0%";
  });
}

/* =========================================================
   USDA API
   ========================================================= */
const USDA_API_KEY = "PdI9gQtlxuwJgjNsfkFzvlarU8u30cMLPTHiJIHT";

async function searchUSDA(query) {
  const url =
    "https://api.nal.usda.gov/fdc/v1/foods/search" +
    `?api_key=${USDA_API_KEY}` +
    "&pageSize=10" +
    "&query=" + encodeURIComponent(query);

  const res = await fetch(url);
  if (!res.ok) throw new Error("API error");
  return (await res.json()).foods || [];
}

function extractMacros(food) {
  const n = food.foodNutrients || [];
  const find = (ids, names) =>
    Number((n.find(x =>
      (x.nutrientNumber && ids.includes(String(x.nutrientNumber))) ||
      (x.nutrientName && names.some(nm => x.nutrientName.toLowerCase().includes(nm)))
    ) || {}).value) || 0;

  return {
    kcal: find(["1008","208"], ["energy"]),
    protein: find(["1003","203"], ["protein"]),
    carbs: find(["1005","205"], ["carbohydrate"]),
    fat: find(["1004","204"], ["fat","lipid"]),
    fiber: find(["1079","291"], ["fiber"])
  };
}

document.getElementById("food-search-form").addEventListener("submit", async e => {
  e.preventDefault();
  const q = document.getElementById("food-search-input").value.trim();
  const apiStatus = document.getElementById("api-status");
  const wrapper = document.getElementById("api-results-wrapper");
  const body = document.getElementById("api-results-body");

  apiStatus.textContent = "Searching USDAâ€¦";
  wrapper.classList.add("hidden");
  body.innerHTML = "";

  try {
    const foods = await searchUSDA(q);
    if (!foods.length) {
      apiStatus.textContent = "No results found.";
      return;
    }

    foods.forEach(f => {
      const m = extractMacros(f);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${f.description}</td>
        <td>${f.householdServingFullText || "100g"}</td>
        <td>${m.kcal}</td>
        <td>${m.protein}</td>
        <td>${m.carbs}</td>
        <td>${m.fat}</td>
        <td>${m.fiber}</td>
        <td><button class="btn primary small">Add</button></td>
      `;
      tr.querySelector("button").onclick = () => {
        meals.push({
          name: f.description,
          kcal: m.kcal,
          protein: m.protein,
          carbs: m.carbs,
          fat: m.fat,
          fiber: m.fiber
        });
        saveMeals();
        renderMealsTable();
        updateMealSummary();
      };
      body.appendChild(tr);
    });

    apiStatus.textContent = "Done. Click Add to log food.";
    wrapper.classList.remove("hidden");

  } catch {
    apiStatus.textContent = "API error.";
  }
});

/* =========================================================
   INIT
   ========================================================= */
document.addEventListener("DOMContentLoaded", () => {
  showRecommended();
  loadTargets();
  loadMeals();
  updateTargetUI();
  renderMealsTable();
  updateMealSummary();
});
</script>

</body>
</html>